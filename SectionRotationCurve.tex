\section{Application -- Milky Way rotation curve}
\label{sec:rotation_curve}

\subsection{Rotation curve fitting}
Since we have a measurement of the $\vlos$ component of the ISM's velocity field over a sizable chunk of the Milky Way disk, we can, in principle, derive the Galactic rotation curve.
Comparing the result to other rotation curves would serve as a check of the quality of our $\vlos$ measurement on large spatial scales, complementing Section \ref{sec:KT-validation}.
Deriving the rotation curve of the ISM from this many independent measurements would also be an advance over most earlier work, which was limited to using measurements of either geometrically special parts of the Galaxy, (e.g. \Clemens) or individual points with potentially non-uniform orbital phase coverage (e.g. \citealt{Reid:2009jb}, \Reid). 

The line-of-sight velocity $\vlos$ at some $\glon$ and heliocentric distance $d$ in the Galactic plane (meaning at $\glat=0^\circ$) is 
\begin{equation}
\label{eqn:vlos_mean}
\vlos(\glon, d) = \frac{V_\phi (\RGC) R_\odot \sin\glon}{\RGC} + 
\frac{V_R (\RGC) \left(R_\odot \cos \glon + d (1 - 2 \cos^2 \glon)  \right) }{\RGC} - V_{\phi, \odot} \sin \glon + V_{R, \odot} \cos \glon,
\end{equation}
where $V_\phi$ and $V_R$ are azimuthal (increasing clockwise) and radial (increasing outward from the Galactic center) velocities, $R_\odot$, $V_{\phi, \odot}$, and $V_{R, \odot}$ are the Galactocentric radius, azimuthal velocity, and radial velocity of the Sun, and $\RGC$ is the Galatocentric distance to the point specified by $\glon$ and $d$:
\begin{equation}
\RGC = \sqrt{R^2_\odot + d^2 - 2 R_\odot d \cos \glon}.
\end{equation}
Here, we have assumed that $V_\phi$ and $V_R$ depend only on $\RGC$, meaning that they are constant as a function of Galactic azimuth.
We will assume that there are no azimuthally constant radial flows, meaning that $V_R(\RGC) \equiv 0\text{ km/sec}$.
Following, e.g., \citet{Reid:2009jb} and \citet{Bovy_2009}, we allow for non-zero azimuthal and radial velocity dispersions, parametrized as independent normal distributions. 
In this parametrization, the line-of-sight velocity dispersion is a normal distribution with variance
\begin{equation}
\label{eqn:vlos_var}
\sigma^2_\mathrm{los} = \left(\sigma_\phi \frac{R_\odot \sin \glon}{\RGC} \right)^2 + 
\left(\sigma_R  \frac{R_\odot \cos \glon + d (1 - 2 \cos^2 \glon)}{\RGC} \right)^2,
\end{equation}
where $\sigma_\phi$ and $\sigma_R$ are the standard deviations of the azimuthal and radial velocity dispersions. 

Our ability to precisely constrain the terms in equations \ref{eqn:vlos_mean} and \ref{eqn:vlos_var} is determined by our $\glon$ and heliocentric distance ranges. 
Since we have measurements over large ranges in both \glon and heliocentric distance, we can precisely infer not only $V_\phi(\RGC)$ and but also $R_\odot$, $V_{\phi, \odot}$, and $V_{R, \odot}$. 
Our ability to infer them \emph{accurately} depends on the accuracy of the $\vlos$ measurements and the correctness of the model.
We have shown that the $\vlos$ measurements are likely to be reasonably accurate; the correctness of the model is less certain.

The biggest potential pitfall is that we have assumed departures from circular rotation, or streaming motions, are spatially uncorrelated.
The magnitude of the systematic errors this sort of model misspecification leads to is depends on the spatial scale on which the streaming motions actually are correlated.
As the scale increases from sub-pixel (i.e. independent) to of order half the extent of the measurement region to of order the extent of the measurement region or larger, the inferred parameters become less and less accurate. 
When the scale is non-negligible but still small compared to the measurement region, the dispersion widths $\sigma_\phi$ and $\sigma_R$ become unreliable.
Once the scale becomes large enough that opposite deviations from circular rotation are not statistically likely to average out, all of the other parameters -- $V_\phi(\RGC)$, $R_\odot$, $V_{\phi, \odot}$, and $V_{R, \odot}$ -- become biased.
Finally, once the scale becomes large enough that the entire measurement region is just looking at a single streaming motion, the streaming motion becomes part of the derived rotation curve.

In figure \ref{fig:six_pies}a, there are clear and obvious streaming motions that extend over several kiloparsecs. 
We can try to model this velocity field with a flat rotation curve, but we should expect the results to be quite biased.
Indeed, if we model the nearest 5 kpc, 

\subsection{Rotation curve fitting}

Deriving the Milky Way's gas rotation curve as a function of Galactocentric radius must be either uninteresting or difficult, given that the last work to do so over a large range of the MW was CITE CLEMENS. The main difficulty appears to be determining distances, particularly outside the solar circle; two (CITE) of the N [\sim 2?] papers since 1984 to derive rotation curves outside the solar circle owe their existence to the CITE REID maser dataset, which has the advantage of containing complete 6D phase space information for each of its targets. The disadvantages of using maser measurements to derive rotation curves are that masers are sparsely distributed and potentially biased tracers of galactic rotation. The 3-dimensional map of line-of-sight velocity as a function of $\ell$, b, and distance loses two of the velocity components provided by the maser dataset, but adds broad and unbiased coverage. Using this 3D map, we can derive the rotation curve of the MW gas in a non-parametric way.

Our derivation resembles most other rotation curve derivations. We assume that the velocity of our tracer population at a given point in space is the superposition of rotation about the galactic center with radially varying speed $v_\phi$, the LSR motion $v_{\phi, \odot}$, and a spatially-varying peculiar velocity. The azimuthal and radial components of the peculiar velocity are assumed to be independent with dispersions (i.e. standard deviations) $\sigma_\phi$ and $\sigma_R$. The radial variation of $v_\phi$ is assumed to be piecewise constant over radial steps of a given size, and the value of $v_\phi$ over each constant step is allowed to be anything within broad lower and upper bounds. The fact that this way of specifying the rotation curve allows more-or-less arbitrary functional shapes is what we mean when we say that our method is non-parametric.

For a given rotation curve $v_\phi(R)$, azimuthal dispersion $\sigma_\phi$, and radial dispersion $\sigma_R$, the likelihood function for a point $\ell_i,b_j,d_k$ in our 3D line-of-sight velocity map is 
\begin{equation}
\label{eqn:rotcurve_likelihood}
p(\mu_{i,j,k} \vert v_{los, \phi}(\ell_i, b_j, d_k), \sigma_{los, i, j, k}) = \frac{1}{\sqrt{2 \pi \sigma^2}} e^{- \frac{(\mu_{i,j,k} - v_{los, \phi})^2}{2 \sigma_{los, i, j ,k}}}
\end{equation}

To compute these projections, we first need an expression for the galactocentric radius at $\ell_i$, $b_j$, $d_k$:
\begin{equation}
\label{eqn:radius}
    R_{i,j,k} = \sqrt{ R_\odot^2 + (d_k \cos b_j)^2 - 2 R_\odot d_k \cos b_j \cos \ell_i}.
\end{equation}
The line-of-sight projection of azimuthal motion is given by the expression
\begin{eqnarray}
\label{eqn:velo-los-phi}
    v_{\rm{los}, \phi}(v_\phi; \ell_i, b_j, d_k) &=& \sin \ell_i \cos b_j  \left( v_\phi \frac{R_\odot}{R_{i,j,k}} - v_{\phi, \odot} \right)\\
    &\equiv& C_{\phi,i,j,k} v_\phi - \sin \ell_i \cos b_j v_{\phi, \odot}.
\end{eqnarray}
The line-of-sight projection of the azimuthal velocity dispersion is just $C_{\phi,i,j,k} \sigma_\phi$. The line-of-sight projection of $v_R$ is given  by 
\begin{eqnarray}
\label{eqn:velo-los-radial}
    v_{\rm{los}, R} (v_R; \ell_i,  b_j, d_k) &=& v_R \frac{\cos b}{R_{i,j,k}} \left( \left( 1 - 2 \cos^2 \ell_i \right) d_k \cos b_j + R_\odot \cos \ell_i \right)\\
    &\equiv& C_{R,i,j,k} v_R,
\end{eqnarray}
and the line-of-sight projection of the radial velocity dispersion is $C_{R,i,j,k} \sigma_\phi$. Since we are assuming the azimuthal and radial velocity dispersions are independent,
\begin{equation}
\label{eqn:velo-los-dispersion}
    \sigma_{\rm{los}} (\sigma_\phi, \sigma_R; \ell_i, b_j, d_k) = \sqrt{ (C_{\phi,i,j,k} \sigma_\phi)^2 + (C_{R,i,j,k} \sigma_R)^2 }.
\end{equation}
We expect the intrinsic $\sigma_\phi$ and $\sigma_R$ to be about 5 km/sec. However, since the 3-cube of line-of-sight velocities is likely to contain errors which we have not explicitly included in our likelihood function, $\sigma_\phi$ and $\sigma_R$ reflect errors in the 3-cube as well as actual departures from the rotation curve. To reflect this, our prior on $\sigma_\phi$ and $\sigma_R$ is a half-normal distribution with left boundary 0 km/sec and one-sided standard deviation 30 km/sec. 

Our final posterior probability distribution is the product of the likelihood function in equation \ref{eqn:rotcurve_likelihood} over each point in the cube, a uniform prior with range RANGE on each piecewise-constant step of the rotation curve, and a half-normal prior with one-sided standard deviation 30 km/sec on $\sigma_\phi$ and $\sigma_R$. 

\subsection{Rotation curve results}
results and comparing to things \ref{fig:rotation_curves}