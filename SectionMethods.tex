\section{Methods}

\subsection{KT / guided gaussian decomposition}

In the introduction, we described our method for mapping the ISM in PPPV space as a kind of inversion of the usual idea of a kinematic distnace. Instead of setting the distance of a voxel in a PPV cube based on the voxel's line-of-sight velocity and a rotation curve, set the velocity of a voxel in a PPP cube based on the voxel's distance and a rotation curve. Since a voxel is not a point, we need to assign it a distribution of velocites rather than a single velocity; we use a Gaussian. This operation is shown for all of the voxels along a single line of sight in Figure (first proj). If we apply this operation a large number of sightlines at a single galactic latitude, we get the $\ell$-$v$ map shown in Figure (first lv). 

The expected velocity-based $\ell-v$ map does not look like the observed $\ell$-$v$ map. Some of the differences between the two $\ell$-$v$ maps are  caused by the low distance resolution of the PPP cube beyond a few kiloparsecs, while others come from us assigning the same fiducial width to every PPP voxel's velocity Gaussian. Many of the differences, however, are clearly caused by the expected velocities being incorrect. These velocity offsets affect not just single pointings but entire extended structures. For example, the line-of-sight velocity of the cloud at $\ell \approx 155^\circ$ is 0 km/sec in the flat rotation-derived map and 5 km/sec in the observed map. In this many other cases, the necessary adjustments to the expected velocities can be picked out by eye.

Since deviations from the expected velocities are clearly necessary, we need to allow them. Practically, "allowing deviations" means varying the center, $\mu_k$, and width, $\sigma_k$, of each distance voxel $k$ to minimize the difference between the model and observed $\ell$-$v$ maps. Along a single line of sight, the difference is given by the expression
\begin{equation}
    \sum_u ((\sum_k f(v_u; \mu_k, \sigma_k)) - y_k)^2,
\end{equation}
where $v_u$ and $y_u$ are the $u$th velocity and column density values along the velocity axis and $f$ is the pixel-convolved Gaussian function.
The objective function over all lines of sight is
\begin{equation}
\label{eqn:objective-nosprings}
    \sum_i \sum_j \sum_u ((\sum_k f(v_u; \mu_{i,j,k}, \sigma_{i,j,k})) - y_{i,j,k})^2,
\end{equation}
where $i$ and $j$ are indices along the $\ell$ and $b$ directions. 

Based on visual inspection of the flat rotation-derived and observed $\ell$-$v$ maps and physical arguments about plausible magnitudes for streaming motions (CITE), we place a bound of 40 km/sec on the magnitude of deviations from flat rotation. Explicitly, $\mu_k$ must be within 40 km/sec of the line-of-sight velocity corresponding to flat rotation at the position of distance voxel $i$. We have found that maximum deviations between 35 and 50 km/sec give similar, though not identical, results.

Figure (varproj) shows a typical [REVISE, FAKE NOT TYPICAL] solution for a single pointing, and Figure (vary lv) shows an $\ell$-$v$ map derived from an actual solution. Apart from a few small mismatches (e.g. at $\ell \approx 80^\circ$ and $v\approx$ $-40$ km/sec), this model gives a faithful reproduction of the observations.

For a given starting PPP 3-cube, there will generally be more than one solution that correctly reproduces the observed PPV 3-cube. Since we are interested in the per-PPP-voxel velocity assignments, we need a way of selecting the solution that is, in some sense, more likely to be the correct one. We do this by adding the constraint that velocity centers of PPP voxels that are adjacent in $\ell$ and $v$ should be similar. We implement this by adding the following term to the objective function in equation \ref{eqn:objective-nosprings}:
\begin{equation}
    \lambda \times \sum_k \left( \sum_i (\mu_{i,j,k} - \mu_{i+1,j,k})^2 + 
    \sum_j (\mu_{i,j,k} - \mu_{i,j+1,k})^2 \right).
\end{equation}
Using this term is an example of Tikhonov regularization. As in equation \ref{eqn:objective-nosprings}, $i$, $j$, and $k$ are indices for the $\ell$, $b$, and distance axes. The strength of the regularization, i.e. the degree to which we require neighboring voxels to have similar centers, is set by $\lambda$. The higher the value of $\lambda$, the more regularized the solution.

In practice, regularizing the solution mainly affects the central velocities of relatively faint, low-mass PPP voxels. Along a typical sightline, therer will be few high-mass voxels in both distance and velocity. The velocity of these high-mass voxels will be well-constrained and will not change from reprojection to reprojection. Moving one of these voxels to a different central velocity would greatly increase the difference bettween the model and observation. Conversely, low-mass voxels tend to be more interchangeable from reprojection to reprojection and more locally movable within a reprojection. As a result, including a regularization term favors solutions in which low-mass voxels' central velocities are similar to any near-by high-mass voxels' central velocities.

Figure (spring proj) shows the effect of including this constraint on a single line of sight solution, and figure (spring lv) shows the corresponding lv map. In both cases, the \emph{fit}, i.e. similarity of model and observation, is not as good as the fit of the uncstrained solution. We find the tradeoff between slightly biased central velocities throughout the diffuse ISM on a local scale and a more unique and correct solution on a global scale to be acceptable. We also find that the regularized solution is in substantially better agreement with the reference dataset, which has complete 6-dimensional phase space measurements for a small number of discrete points throughout the galaxy (see Sec. Masers). 

The actual PPPV reconstruction, then, comes from evaluating the velocity Gaussians from the previous step at their positions in the PPP cube and not projecting down to PPV space. A more easily visualizable summary of the solution is the 3-cube fo velocity centers, which gives the mean motion of the ISM as a function of on-sky position and distance. We explore a few views of this 3-cube in Sec. Results. We can use this 3-cube to derive a non-parametric galactic rotation curve. Our procedure for this derivation is given in the next section. 

\subsection{Rotation curve fitting}

Deriving the Milky Way's gas rotation curve as a function of galactocentric radius must be either uninteresting or difficult, given that the last work to do so over a large range of the MW was CITE CLEMENS. The main difficulty appears to be determining distances, particularly outside the solar circle; two (CITE) of the N [\sim 2?] papers since 1984 to derive rotation curves outside the solar circle owe their existance to the CITE REID maser dataset, which has the advantage of containing complete 6D phase space information for each of its targets. The disadvantages of using maser measurements to derive rotation curves are that masers are sparssely distributed and potentially biasd tracers of galactic rotation. The 3-dimensional map of line-of-sight velocity as a function of $\ell$, b, and distance loses two of the velocity components provided by the maser dataset, but adds broad and unbiased coverage. Using this 3D map, we can derive the rotation curve of the MW gas in a non-parametric way.

Our derivation resembles most other rotation curve derivations. We assume that the velocity of our tracer population at a given point in space is the superposition of rotation about the galactic center with radially varying speed $v_\phi$, the LSR motion $v_{\phi, \odot}$, and a spatially-varying peculiar velocity. The azimuthal and radial components of the peculiar velocity are assumed to be independent with dipersions (i.e. standard deviations) $\sigma_\phi$ and $\sigma_R$. The radial variation of $v_\phi$ is assumed to be piecewise constant over radial steps of a given size, and the value of $v_\phi$ over each constant step is allowed to be anything within broad lower and upper bounds. The fact that this way of specifying the rotation curve allows more-or-less arbitrary functional shapes is what we mean when we say that our method is non-parametric.

For a given rotation curve $v_\phi(R)$, azimuthal dispersion $\sigma_\phi$, and radial dispersion $\sigma_R$, the likelihood function for a point $\ell_i,b_j,d_k$ in our 3D line-of-sight velocity map is 
\begin{equation}
\label{eqn:rotcuve_likelihood}
p(\mu_{i,j,k} \vert v_{los, \phi}(\ell_i, b_j, d_k), \sigma_{los, i, j, k}) = \frac{1}{\sqrt{2 \pi \sigma^2}} e^{- \frac{(\mu_{i,j,k} - v_{los, \phi})^2}{2 \sigma_{los, i, j ,k}}}
\end{equation}

To compute these projections, we first need an expression for the galactocentric radius at $\ell_i$, $b_j$, $d_k$:
\begin{equation}
\label{eqn:radius}
    R_{i,j,k} = \sqrt{ R_\odot^2 + (d_k \cos b_j)^2 - 2 R_\odot d_k \cos b_j \cos \ell_i}.
\end{equation}
The line-of-sight projection of azimuthal motion is given by the expression
\begin{eqnarray}
\label{eqn:velo-los-phi}
    v_{\rm{los}, \phi}(v_\phi; \ell_i, b_j, d_k) &=& \sin \ell_i \cos b_j  \left( v_\phi \frac{R_\odot}{R_{i,j,k}} - v_{\phi, \odot} \right)\\
    &\equiv& C_{\phi,i,j,k} v_\phi - \sin \ell_i \cos b_j v_{\phi, \odot}.
\end{eqnarray}
The line-of-sight projection of the azimuthal velocity dispersion is just $C_{\phi,i,j,k} \sigma_\phi$. The line-of-sight projection of $v_R$ is given  by 
\begin{eqnarray}
\label{eqn:velo-los-radial}
    v_{\rm{los}, R} (v_R; \ell_i,  b_j, d_k) &=& v_R \frac{\cos b}{R_{i,j,k}} \left( \left( 1 - 2 \cos^2 \ell_i \right) d_k \cos b_j + R_\odot \cos \ell_i \right)\\
    &\equiv& C_{R,i,j,k} v_R,
\end{eqnarray}
and the line-of-sight projection of the radial velocity disperion is $C_{R,i,j,k} \sigma_\phi$. Since we are assuming the azimuthal and radial velocity dispersions are independent,
\begin{equation}
\label{eqn:velo-los-dispersion}
    \sigma_{\rm{los}} (\sigma_\phi, \sigma_R; \ell_i, b_j, d_k) = \sqrt{ (C_{\phi,i,j,k} \sigma_\phi)^2 + (C_{R,i,j,k} \sigma_R)^2 }.
\end{equation}
We expect the intrinsic $\sigma_\phi$ and $\sigma_R$ to be about 5 km/sec. However, since the 3-cube of line-of-sight velocities is likely to contain errors which we have not explictly included in our likelihood function, $\sigma_\phi$ and $\sigma_R$ reflect errors in the 3-cube as well as actual departures from the rotation curve. To reflect this, our prior on $\sigma_\phi$ and $\sigma_R$ is a half-normal distribution with left boundary 0 km/sec and one-sided standard deviation 30 km/sec. 

Our final posterior probability distribution is the product of the likelihood function in equation \ref{eqn:rotcurve_likelihood} over each point in the cube, a uniform prior with range RANGE on each piecewise-constant step of the rotation curve, and a half-normal prior with one-sided standard deviation 30 km/sec on $\sigma_\phi$ and $\sigma_R$. 
