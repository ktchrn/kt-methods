\section{Kinetic tomography}
\label{sec:KT}
We have developed a procedure for deriving the distribution of interstellar matter in position-position-distance-velocity (PPDV) space from measurements of its distribution in position-position-distance (PPD) and position-position-velocity (PPV) space. 
The technical term for deriving a multi-dimensional distribution from lower-dimensional measurements is tomographic reconstruction; in this context, lower-dimensional measurements are called projections. 
As should be intuitively clear, tomographic reconstruction from two projections is, in general, not possible -- there are many more independent variables than observational constraints. 
Our procedure for solving our specific case of the tomographic reconstruction problem is based around exploiting some simplifying assumptions about the structure of the ISM in PPDV space to reduce the number of independent variables.

For motivation, we first examine the structural assumptions behind a common technique for finding solutions to the even more underdetermined problem of reconstructing a PPDV-space ISM distribution from PPV-space measurements alone. 
The  technique we are referring to here is the widely known kinematic distance method (e.g. \citealt{Levine_2006}), which assigns distances to observed line-of-sight velocities based on an assumed Galactic rotation curve and geometry. 
While the kinematic distance technique is usually presented as a way of converting PPV-space distributions to PPD-space, rather than PPDV-space, distributions, its underlying assumptions make the two equivalent. 
These assumptions can be combined into a single statement: (1) a location in PPD space can be assigned a single line-of-sight velocity (2) according to an assumed rotation curve and Galactic geometry. 
From these assumptions it follows that knowing the PPD-space distribution of the ISM is equivalent to knowing its PPDV-space distribution. 

We have PPD-space measurements in addition to PPV-space measurements, allowing us to make a more relaxed version of this assumption. 
Our version is that (1) a parcel of interstellar matter in PPD space can be assigned a Gaussian distribution of line-of-sight velocities (2) whose center is within a fixed range of the line-of-sight velocity predicted by an assumed rotation curve and Galactic geometry. 
Here, a "parcel" of interstellar matter refers to the contents of a single PPD voxel. 
For each voxel in observed PPD cube, we aim to assign a central line-of-sight velocity $\vlos$ and a line-of-sight Gaussian velocity width $\sigma_v$. 
With these assumptions, a description of the ISM in PPDV space consists of a description of its PPD-space distribution (the observed PPD cube), a line-of-sight central velocity cube in PPD space ($\vlos(\glon, \glat, d)$), and a line-of-sight velocity width cube in PPD space ($\sigma_v (\glon, \glat, d)$). 
Thus we have reduced our original problem of finding a PPDV cube which is consistent with our observed PPD and PPV cubes to finding a $\vlos(\glon, \glat, d)$ and $\sigma_v(\glon, \glat, d)$ pair consistent with our PPV observations.

%We have developed a procedure for deriving the distribution of interstellar matter in position-position-distance-velocity (PPDV) space from measurements of its distribution in position-position-distance (PPD) and position-position-velocity (PPV) space. The technical term for deriving a multi-dimensional distribution from lower-dimensional measurements is tomographic reconstruction; in this context, lower-dimensional measurements are called projections. As should be intuitively clear, tomographic reconstruction from two projections is, in general, not possible -- there are many more independent variables than observational constraints. The procedure we have devised to solve our specific case of the tomographic reconstruction problem is based around exploiting some simplifying assumptions about the structure of the ISM in PPDV space to bring the number of independent variables closer to the number of observational constraints. 

%Our strategy for solving this problem is based on two major assumptions: (1) a parcel of interstellar matter can be assigned a single Gaussian distribution of line-of-sight velocities and (2) that the center of this distribution resides in a bounded subregion of the PPDV space. This first assumption is a relaxed version of a core assumption of the kinematic distance method --- that a distance can be converted into a velocity. In the kinematic distance method, a direct dependence of distance on observed line-of-sight velocity is derived from a assumed rotation curve \citep[e.g.][]{Levine_2006}. In our method, we instead assume that a parcel of gas has a single \emph{central} velocity, but allow for a dispersion about this center. This assumption inherently limits our method to resolving ISM flows larger than the PPD voxels. Our second assumption can also be considered a relaxation of the kinematic distance method's assumed fixed rotation curve. We assume that the line-of-sight velocity of a parcel must lie within some interval about the value expected from an assumed rotation curve. 

%In our method, a parcel of interstellar material is associated to a single PPD voxel. For each of these voxels we aim to assign both a central line-of-sight velocity $\vlos$ and a line-of-sight Gaussian velocity width $\sigma_v$. Thus, we have reduced the description of the ISM in PPDV space to the description of a density field (the original PPD cube), a line-of-sight central velocity cube in PPD space($\vlos\left(\glon, \glat, d \right)$), and a line-of-sight velocity width cube in PPD space ($\sigma_v \left(\glon, \glat, d \right)$). Thus we have reduced our original problem of finding a PPDV cube which is consistent with our observed PPD and PPV cubes to finding a $\vlos\left(\glon, \glat, d \right)$ and $\sigma_v \left(\glon, \glat, d \right)$ pair consistent with our PPV observations. 

%This method can be understood as a variation on CfR's extension of kinematic distances.
%The kinematic distance to a point at some on-sky position ($\ell$, b) and line-of-sight velocity $v$ is the distance at which a model of gas motion in that ($\ell$, b) direction is equal to $v$.
%The gas motion model is usually taken to be a galactic rotation curve. 

%Kinematic distances have several well-known drawbacks.
%Firstly, they are not unique in directions where different distances are assigned the same line-of-sight velocity.
%When a flat rotation curve is assumed, sightlines inside the solar circle and towards the galactic anti-center do not have unique distances. 
%Next, kinematic distances ignore the possibility of deviations from the gas motion model.
%Measurements of the distances and line-of-sight velocities of point-like objects such as masers show that deviations from azimuthally symmetric rotation, or streaming motions, are the norm rather than the exception.
%In some cases, streaming motions can mean that there is no distance corresponding to a given velocity. 
%This is known to happen towards the galactic anti-center CITE and near the galactic center CITE.
%Finally, computing kinematic distances for an entire PPV dataset yields a PPP dataset, trading one map of three-dimensional structure for another.
%Despite these drawbacks, kinematic distances are an adequate estimate of actual distances over much of the galactic plane.

%CfR's method improves on kinematic distances by treating them as one of a number of context clues to the distance to an object.
%Other context clues include the physical size and height above the galactic plane that a distance would imply given the object's angular size and height above the galactic plane, the presence or absence of H I 21cm self-absorption in the direction of the object, and the distances to any other objects that are known to be close to the object of interest.
%If there are enough context clues, this approach can help resolve the degeneracy between distances that correspond to the same line-of-sight velocity and can be used to detect and measure streaming motions.

%If we think of kinematic distances as a somewhat unstable zeroth-order approximation to the distance corresponding to a point in a PPV dataset, CfR's method is a second-order correction with improved stability properties.
%From this perspective, building on CfR's method is unlikely to lead to  significant improvements to their solution.
%Instead, we apply a rudimentary form of their approach to the complementary problem of assigning a velocity to a point in a PPP dataset.

%With the advent of large optical and near-infrared photometric surveys, it has become possible to build maps of the three-dimensional distribution of dust out several kiloparsecs from the Sun CITE.
%If we make some assumptions about the mixing and relative abundances of dust and gas in the ISM, we can consider these maps to be of the three-dimensional stucture of the ISM. 

%To get a zeroth-order velocity for a point in one of these PPP maps, we can take inspiration from kinematic distances and evaluate the galactic rotation curve at its position. 
%Even at this stage, the PPP to PPPV problem has an advantage over the PPV to PPPV problem -- the position to velocity assignment is unique, if not necessarily accurate.
%There are different possible approaches to improving this approximation.
%Our approach is to use a PPV dataset of the ISM over the same area as a guide.
%Reproducing this PPV dataset requires modestly adjusting the velocities assigned to the points in the PPP dataset.
%These adjusted velocity assignments are our PPPV map.

%We have checked this map against the maser measurements in CITET REID (R14). 
%Reid et al. have measured the distance to and line-of-sight velocity of a number of masers.
%Our PPPV map evaluated at the on-sky positions and distances of the masers agrees with the masers' measured line-of-sight velocities.
%This is particularly heartening considering that many of the masers are known to deviate significantly from galactic rotation.

\subsection{Formalism}
\label{sec:KT-method}
In the introduction, we described our method for mapping the ISM in PPPV space as a kind of inversion of the usual idea of a kinematic distance. Instead of setting the distance of a voxel in a PPV cube based on the voxel's line-of-sight velocity and a rotation curve, set the velocity of a voxel in a PPP cube based on the voxel's distance and a rotation curve. Since a voxel is not a point, we need to assign it a distribution of velocites rather than a single velocity; we use a Gaussian. This operation is shown for all of the voxels along a single line of sight in Figure (first proj). If we apply this operation a large number of sightlines at a single galactic latitude, we get the $\ell$-$v$ map shown in figure (first lv). 

The expected velocity-based $\ell$-$v$ map does not look like the observed $\ell$-$v$ map. Some of the differences between the two $\ell$-$v$ maps are  caused by the low distance resolution of the PPP cube beyond a few kiloparsecs, while others come from us assigning the same fiducial width to every PPP voxel's velocity Gaussian. Many of the differences, however, are clearly caused by the expected velocities being incorrect. These velocity offsets affect not just single pointings but entire extended structures. For example, the line-of-sight velocity of the cloud at $\ell \approx 155^\circ$ is 0 km/sec in the flat rotation-derived map and 5 km/sec in the observed map. In this and many other cases, the necessary adjustments to the expected velocities can be picked out by eye.

Since deviations from the expected velocities are clearly necessary, we need to allow them. Practically, "allowing deviations" means varying the center, $\mu_k$, and width, $\sigma_k$, of each distance voxel $k$ to minimize the difference between the model and observed $\ell$-$v$ maps. Along a single line of sight, the difference is given by the expression
\begin{equation}
    \sum_u ((\sum_k f(v_u; \mu_k, \sigma_k)) - y_k)^2,
\end{equation}
where $v_u$ and $y_u$ are the $u$th velocity and column density values along the velocity axis and $f$ is the pixel-convolved Gaussian function.
The objective function over all lines of sight is
\begin{equation}
\label{eqn:objective-nosprings}
    \sum_i \sum_j \sum_u ((\sum_k f(v_u; \mu_{i,j,k}, \sigma_{i,j,k})) - y_{i,j,k})^2,
\end{equation}
where $i$ and $j$ are indices along the $\ell$ and $b$ directions. 

Based on visual inspection of the flat rotation-derived and observed $\ell$-$v$ maps and physical arguments about plausible magnitudes for streaming motions (CITE), we place a bound of 40 km/sec on the magnitude of deviations from flat rotation. Explicitly, $\mu_k$ must be within 40 km/sec of the line-of-sight velocity corresponding to flat rotation at the position of distance voxel $i$. We have found that maximum deviations between 35 and 50 km/sec give similar, though not identical, results.

Figure (varproj) shows a typical [REVISE, FAKE NOT TYPICAL] solution for a single pointing, and Figure (vary lv) shows an $\ell$-$v$ map derived from an actual solution. Apart from a few small mismatches (e.g. at $\ell \approx 80^\circ$ and $v\approx$ $-40$ km/sec), this model gives a faithful reproduction of the observations.

For a given starting PPP 3-cube, there will generally be more than one solution that correctly reproduces the observed PPV 3-cube. Since we are interested in the per-PPP-voxel velocity assignments, we need a way of selecting the solution that is, in some sense, more likely to be the correct one. We do this by adding the constraint that velocity centers of PPP voxels that are adjacent in $\ell$ and $v$ should be similar. We implement this by adding the following term to the objective function in equation \ref{eqn:objective-nosprings}:
\begin{equation}
    \lambda \times \sum_k \left( \sum_i (\mu_{i,j,k} - \mu_{i+1,j,k})^2 + 
    \sum_j (\mu_{i,j,k} - \mu_{i,j+1,k})^2 \right).
\end{equation}
Using this term is an example of Tikhonov regularization. As in equation \ref{eqn:objective-nosprings}, $i$, $j$, and $k$ are indices for the $\ell$, $b$, and distance axes. The strength of the regularization, i.e. the degree to which we require neighboring voxels to have similar centers, is set by $\lambda$. The higher the value of $\lambda$, the more regularized the solution.

In practice, regularizing the solution mainly affects the central velocities of relatively faint, low-mass PPP voxels. Along a typical sightline, there will be few high-mass voxels in both distance and velocity. The velocity of these high-mass voxels will be well-constrained and will not change from reprojection to reprojection. Moving one of these voxels to a different central velocity would greatly increase the difference bettween the model and observation. Conversely, low-mass voxels tend to be more interchangeable from reprojection to reprojection and more locally movable within a reprojection. As a result, including a regularization term favors solutions in which low-mass voxels' central velocities are similar to any near-by high-mass voxels' central velocities.

Figure (spring proj) shows the effect of including this constraint on a single line of sight solution, and figure (spring lv) shows the corresponding lv map. In both cases, the \emph{fit}, i.e. similarity of model and observation, is not as good as the fit of the unconstrained solution. We find the trade-off between slightly biased central velocities throughout the diffuse ISM on a local scale and a more unique and correct solution on a global scale to be acceptable. We also find that the regularized solution is in substantially better agreement with the reference dataset, which has complete 6-dimensional phase space measurements for a small number of discrete points throughout the galaxy (see section \ref{sec:KT-validation}). 

The actual PPPV reconstruction, then, comes from evaluating the velocity Gaussians from the previous step at their positions in the PPP cube and not projecting down to PPV space. A more easily visualizable summary of the solution is the 3-cube of velocity centers, which gives the mean motion of the ISM as a function of on-sky position and distance.
